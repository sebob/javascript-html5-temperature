<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" href="css/website.css" type="text/css" media="screen" />
        <link rel="icon" type="image/png" href="images/favicon.png">
        <script src="http://code.jquery.com/jquery-1.7.1.min.js" ></script>
        <!-- Place this tag in your head or just before your close body tag -->
        <script type="text/javascript" src="https://apis.google.com/js/plusone.js"></script>
        <script type='text/javascript' src='https://www.google.com/jsapi'></script>
        <script type='text/javascript' src='scripts/cruiser.js'></script>

        <script type='text/javascript' src='scripts/specifications.js'></script>
        <script type='text/javascript' src='scripts/pl-PL.js'></script>
        <script type='text/javascript' src='scripts/core.js'></script>
        <script type='text/javascript' src='scripts/parser.js'></script>
        <script type='text/javascript' src='scripts/sugarpak.js'></script>
        <script type='text/javascript' src='scripts/time.js'></script>
        <script type='text/javascript' src='scripts/extras.js'></script>

        
        <style>
        #byte_content {
            margin: 5px 0;
            max-height: 100px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        #byte_range { margin-top: 5px; }
        </style>
  <script>
        //google.load('visualization', '1', {packages:['imagelinechart']});
        //google.setOnLoadCallback(drawChart);
        google.load("visualization", "1", {packages:["corechart"]});
        wykres2 = function(dane,start,stop,p_czas, czas_od, czas_do)
        {
            var czas = Date.today().set(getTime(start));
            var list = new Array();
            
            //console.log(new Date(parseInt(czas_od)), new Date(parseInt(czas_do)),new Date(czas.getTime()));
            //console.log(czas_od, parseInt(czas_do));
            
            $.each(dane, function(index, value) {
                    list.push(
                        [
                            czas.toString('HH:mm'),
                            parseInt(value,16),
                            czas.toString('yyyy/M/d'), 
                            czas.getTime()
                        ]
                    );
                    czas.addSeconds(3.158);
            });

            var ilosc_minut = p_czas;
            var jsCzasu = (19 * ilosc_minut);    

            var test = new Array();
                test.push(['Wybierz',0,0]);
            var tablicaCzasow = new Array();

            
            $.each(list, function(index, val) {
                if(index%jsCzasu==0) {
                    if(val[3] >= parseInt(czas_od) && val[3] <= new Date(parseInt(czas_do)).getTime() && czas_od <= czas_do) { 
                      tablicaCzasow.push([val[0],val[1]]);  
                    }
                    
                    if(parseInt(czas_od) == 0 || parseInt(czas_do) == 0 || czas_od > czas_do){
                      tablicaCzasow.push([val[0],val[1]]);  
                    }
                }
                if(index%1440 == 0){
                    test.push([new Date(val[3]).toString('d/M/yyyy HH:mm'),val[3]]);
                }
            });
            if($('select[name="czas_od"] option').length == 0 && $('select[name="czas_do"] option').length == 0) {
                var select_data_od = $('<select name="czas_od" />');
                var select_data_do = $('<select name="czas_do" />');
                $.each(test, function(key, value) {
                    $(select_data_od).append($("<option></option>").attr("value",value[1]).text(value[0]));
                    $(select_data_do).append($("<option></option>").attr("value",value[1]).text(value[0]));
                });

                $('select[name="czas"]').after(select_data_do);
                $('select[name="czas"]').after(select_data_od);
            }

            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Czas t['+p_czas+'m]');
            data.addColumn('number', 'Temperatura \u00B0 C');
            data.addRows(tablicaCzasow);

            var przedzial = (parseInt(czas_od) > 0 && parseInt(czas_do) > 0 ) ? '| Wybrany przedział czasu: '
                + new Date(parseInt(czas_od)).toString('d/M/yyyy HH:mm') 
                + ' - ' 
                + new Date(parseInt(czas_do)).toString('d/M/yyyy HH:mm') : '';

            var options = {
                title: 'Wykres temperatury od:'+start+ ((stop > 0)?' do: '+stop:'')+', co '+ilosc_minut+" minut.",
                width: 1400, height: 340,
                enableInteractivity: true,
                focusTarget: true,
                strictFirstColumnType: true,
                showRowNumber: true,
                showValue: true,
                legend: true,
                pointSize: 2,
                series: [{color: '#9797E5', visibleInLegend: true},{}, {}, {color: 'red', visibleInLegend: false}],
                tooltop: {textStyle: {color: '#FF0000'}, showColorCode: true},
                showAxisLines: true,
                
                hAxes:[{title:'Czas t['+p_czas+'m] \u000A'+ przedzial,textStyle:{color: 'red',fontSize:12}}],
                vAxes:[
                    {title:'Temperatura \u00B0 C',textStyle:{color: 'red',fontSize:11}}
                ],
                hAxis: {title: 'Czas t['+p_czas+'m] ', titleTextStyle: {color: 'black', fontSize: 12, fontName: 'Verdana, Arial'}},
                vAxis: {titlePosition: 'out', title: 'Temperatura \u00B0 C', titleTextStyle: {color: '#9797E5', fontSize: 12, fontName: 'Verdana, Arial'}},
                chartArea: {left: 40, top: 60}
            };

            var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            
            chart.draw(data, options);
 
        }
        
        getTime = function(strTime)
        {
            var tabData = strTime.split("-");
            //console.log(tabData);
            var tabTime = tabData[3].split(":");
            var time = new Date();
            
            return {
                millisecond: 0,
                second: 0,
                minute: parseFloat(tabTime[1]),
                hour: parseFloat(tabTime[0]), 
                day: parseFloat(tabData[2]),
                month: (parseInt(tabData[1])-1),
                year: parseFloat(tabData[0])
            };
        }
        
        diffTime = function(time1,time2)
        {
            return time1 - time2;
        }
        
    </script>
    </head>
    <body>
        <input type="file" id="files" name="file" />
        <span class="readBytesButtons">
            Ilość minut:
            <select name="czas">
                <option value="1">1 m</option>
                <option value="5">5 m</option>
                <option value="10">10 m</option>
                <option value="15">15 m</option>
                <option value="30">30 m</option>
                <option value="45">45 m</option>
                <option value="60" selected="selected">60 m</option>
                <option value="90">90 m</option>
                <option value="120">120 m</option>
                <option value="240">240 m</option>
                <option value="1440">24 h</option>
            </select>
        <button>Wczytaj plik</button>
        </span>
        <div id="start"></div>
        <div id="end"></div>

        <script>
        function readBlob(opt_startByte, opt_stopByte, czas, czas_od, czas_do) {

            var files = document.getElementById('files').files;
            if (!files.length) {
            alert('Wybierz plik!');
            return;
            }

            var file = files[0];
            var start = parseInt(opt_startByte) || 0;
            var stop = parseInt(opt_stopByte) || file.size - 1;
            
            var reader = new FileReader();

            // If we use onloadend, we need to check the readyState.
            reader.onloadend = function(evt) {
            if (evt.target.readyState == FileReader.DONE) { // DONE == 2
                var plik = new String(evt.target.result);
                var reg = /\d{4}-\d{2}-\d{2}\s-\s\d{2}:\d{2}:\d{2}/g;
                var tablicaWynikow = plik.match(reg);
                //console.log(tablicaWynikow);
                
                var reg_dane = /\w{2}/gm;
                var dane2 = plik.replace(reg,"");
                var dane3 = dane2.replace("Terminal log file","");
                var dane4 = dane3.replace("Date:","");
                var dane5 = dane4.replace("-","");
                var dane6 = dane5.replace("End log file","");
                var dane7 = dane6.replace("Date","");
                var dane8 = dane7.replace(/(\r\n|\n|\r|\W)/gm,"");
                //console.log(dane8);
                var dane_docelowe1 = dane8.match(reg_dane);
                //console.log(dane5);
                //console.log(dane_docelowe1.length);
                
                //wykres(dane_docelowe,tablicaWynikow[0],tablicaWynikow[1]);
                wykres2(dane_docelowe1,tablicaWynikow[0],tablicaWynikow[1],czas, czas_od, czas_do);
                
                
                //document.getElementById('start').textContent = tablicaWynikow[0];//evt.target.result;
                //document.getElementById('end').textContent = tablicaWynikow[1];
                
                //var time1 = getTime(tablicaWynikow[0]);
                //var time2 = getTime(tablicaWynikow[1]);
                //var xxx = new Date(diffTime(time1, time2));

            //console.log(xxx.getSeconds());
                
                    ['Read bytes: ', start + 1, ' - ', stop + 1,
                    ' of ', file.size, ' byte file'].join('');
            }
            };

            if (file.webkitSlice) {
            var blob = file.webkitSlice(start, stop + 1);
            } else if (file.mozSlice) {
            var blob = file.mozSlice(start, stop + 1);
            }
            reader.readAsBinaryString(blob);
        }

        document.querySelector('.readBytesButtons').addEventListener('click', function(evt) {
            if (evt.target.tagName.toLowerCase() == 'button') {
                var startByte = evt.target.getAttribute('data-startbyte');
                var endByte = evt.target.getAttribute('data-endbyte');
                var czas = $('select[name="czas"] option:selected').val();
                var czas_od = ($('select[name="czas_od"] option').length > 0)?$('select[name="czas_od"] option:selected').val() : 0;
                var czas_do = ($('select[name="czas_do"] option').length > 0)?$('select[name="czas_do"] option:selected').val() : 0;
                
                readBlob(startByte, endByte, parseInt(czas),czas_od,czas_do);            
            }
        }, false);
        </script>
        <div style="text-align: center" id="chart_div">

        </div>
    </body>
</html>
